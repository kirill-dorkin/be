# Управление каталогом ремонтных услуг

Эта инструкция описывает, как работает встроенный каталог ремонтных услуг Nimara и каким образом заявки из витрины автоматически превращаются в черновики заказов в Saleor. Материал ориентирован на сотрудников сервисного центра и администраторов, которым нужно понимать полный цикл: от наполнения каталога до назначения исполнителей.

## 1. Источники данных
- `apps/storefront/src/lib/repair-services/data.ts` — основной файл со всеми услугами: название, категории, цены, длительность и подсказки для формы заявки.
- `apps/storefront/src/lib/repair-services/seed.ts` — конвертер, который превращает данные из `data.ts` в структуру, подходящую для массового импорта в Saleor (мутация `productBulkCreate`).
- `apps/storefront/src/app/api/repair-services/route.ts` — публичный API, возвращающий каталог услуг для внешних интеграций.
- `apps/storefront/src/app/api/service-request/route.ts` — API, которое принимает заявки клиентов и создаёт черновой заказ в Saleor.

## 2. Подготовка Saleor к работе с услугами
1. **Настройте каналы.** Убедитесь, что заданы переменные окружения `SERVICE_CHANNEL_SLUG` и `SERVICE_CATEGORY_SLUG`. По умолчанию используются `default-channel` и `repair-services`.
2. **Создайте тип товара.** В разделе **Products → Product Types** создайте тип `Repair Service` с атрибутами:
   - `device-type` — устройство (например, iPhone, MacBook).
   - `service-group` — группа услуг (диагностика, ремонт, аксессуары).
   - `service-category` — уточняющая категория.
   - `pricing-kind` — тип ценообразования (фиксированная цена, диагностика и т.д.).
3. **Импортируйте услуги.**
   - Выполните запрос `GET https://<домен витрины>/api/repair-services/seed`.
   - Полученный JSON содержит готовый набор данных для мутации `productBulkCreate` в Saleor Cloud.
   - После импорта проверьте цены, описания и публикацию в нужных каналах.
4. **Проверьте отображение на сайте.** Каталог автоматически появляется на странице [services](https://github.com/kirill-dorkin/be/blob/main/apps/storefront/src/app/%5Blocale%5D/(main)/services/page.tsx). Убедитесь, что услуги видны и фильтры работают корректно.

## 3. Назначение и управление исполнителями
1. **Создайте группу прав.** В разделе **Configuration → Permission Groups** создайте группу, например *Repair Workers*. Имя можно переопределить через переменную `SERVICE_WORKER_GROUP_NAME`.
2. **Выдайте доступы.** Для группы включите канал `SERVICE_CHANNEL_SLUG` и отметьте минимум разрешение `MANAGE_ORDERS`.
3. **Добавьте сотрудников.**
   - Зайдите в **Configuration → Staff Members → Add staff member**.
   - Укажите рабочий email, задайте пароль или отправьте приглашение.
   - Отметьте созданную группу *Repair Workers* (или другое выбранное название).
4. **Управляйте активностью.** Только активные сотрудники в этой группе получают заявки. Если нужно временно отключить исполнителя, снимите галочку **Is active** — автоматизация перестанет назначать ему задачи.
5. **Проверяйте назначения.** Каждый созданный черновой заказ содержит приватный комментарий с именем выбранного сотрудника. Комментарий виден на вкладке **History** внутри заказа.

## 4. Как формируются заявки
- При отправке формы «Заказать ремонт» фронтенд отправляет `POST /api/service-request`.
- API ищет нужную услугу по `slug` и добавляет её в черновик заказа.
- В метаданных заказа сохраняются контактные данные клиента, предварительная оценка и выбранная услуга.
- Список доступных работников берётся из группы, указанной в `SERVICE_WORKER_GROUP_NAME`; выбирается случайный активный сотрудник.
- В приватную заметку заказа записывается краткое резюме заявки и имя назначенного специалиста.

## 5. Ежедневные задачи менеджера
- **Проверять новые черновики.** В разделе **Orders → Drafts** отображаются свежие заявки. Менеджер связывается с клиентом, подтверждает детали и превращает черновик в обычный заказ.
- **Обновлять цены и описания.** Меняйте стоимость, тексты и фотографии прямо в карточках услуг. Если нужно массовое обновление — скорректируйте `data.ts` и снова выполните импорт.
- **Следить за составом команды.** Добавляйте новых сотрудников, удаляйте ушедших, корректируйте права доступа.
- **Контролировать аналитику.** Используйте отчёты Saleor и маркетинговые инструменты, чтобы оценивать спрос на услуги.

## 6. Обновление каталога
1. Откройте файл [`data.ts`](https://github.com/kirill-dorkin/be/blob/main/apps/storefront/src/lib/repair-services/data.ts) и добавьте новую услугу или измените существующую.
2. При необходимости обновите маппер [`mapServiceToSaleorSeed`](https://github.com/kirill-dorkin/be/blob/main/apps/storefront/src/lib/repair-services/seed.ts), если появились новые поля или атрибуты.
3. Получите свежий JSON через `GET /api/repair-services/seed` и повторно выполните импорт в Saleor.
4. Проверьте, что услуга отображается на витрине и доступна для оформления заявки.

## 7. Полезные улучшения на будущее
- **Хранить модификаторы расчётов в Saleor.** Как только вся информация переедет в панель, можно отказаться от ручного редактирования `data.ts`.
- **Выделить отдельное приложение для заявок.** Например, сохранить заявки в базе данных, отправлять уведомления исполнителям и вести историю изменений.
- **Подключить интеграции.** Синхронизируйте задачи с CRM или системой учёта сервисного центра через API `/api/repair-services` и `/api/service-request`.

Если возникли вопросы или требуется помощь с импортом, обратитесь к администратору Saleor или создайте запрос в службе поддержки.

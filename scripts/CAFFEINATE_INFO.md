# ☕ Caffeinate - Предотвращение засыпания Mac

## Что это?

`caffeinate` - встроенная утилита macOS которая предотвращает засыпание компьютера.

## Почему это нужно для скрипта?

Когда экран Mac тухнет или компьютер засыпает:

- ❌ Chrome переходит в спящий режим
- ❌ WebSocket соединение закрывается
- ❌ Скрипт падает с ошибкой "Connection closed"
- ❌ Процесс прерывается

С `caffeinate`:

- ✅ Экран остается активным
- ✅ Chrome продолжает работать
- ✅ WebSocket соединение остается открытым
- ✅ Скрипт работает без проблем

## Как это работает?

```bash
caffeinate -d pnpm images:add
```

### Флаги caffeinate:

- `-d` (display) - предотвращает засыпание дисплея
- `-i` (idle) - предотвращает idle sleep (не используем, так как нужен экран)
- `-s` (system) - предотвращает системное засыпание (не нужно с `-d`)

## Автоматическое использование

Команда `pnpm images:add` уже включает `caffeinate -d`:

```json
// package.json
{
  "scripts": {
    "images:add": "caffeinate -d dotenv -- node scripts/add_product_images.js"
  }
}
```

## Что происходит?

1. Вы запускаете: `pnpm images:add`
2. `caffeinate -d` запускается и блокирует засыпание экрана
3. Скрипт работает (экран не тухнет, Chrome активен)
4. Скрипт завершается
5. `caffeinate` автоматически отключается
6. Mac возвращается к обычным настройкам энергосбережения

## Проверка работы

Запустите и попробуйте подождать:

```bash
# Тест без caffeinate (закроется через N минут когда экран потухнет)
dotenv -- node scripts/add_product_images.js

# Тест с caffeinate (будет работать даже если экран должен потухнуть)
caffeinate -d dotenv -- node scripts/add_product_images.js
```

## Дополнительные примеры

```bash
# Предотвратить засыпание на 1 час (3600 секунд)
caffeinate -t 3600

# Предотвратить засыпание пока работает процесс
caffeinate -d command

# Предотвратить все типы засыпания
caffeinate -dims command
```

## Мониторинг

Проверить что caffeinate работает:

```bash
# В другом терминале
ps aux | grep caffeinate
```

Вы увидите процесс `caffeinate -d dotenv -- node scripts/add_product_images.js`

## Альтернативы (не рекомендуется)

### 1. Изменить настройки системы (неудобно)

```
System Preferences → Energy Saver → Never sleep
```

Минусы: нужно менять обратно после работы

### 2. Программа Amphetamine (избыточно)

Минусы: нужно устанавливать дополнительное ПО

### 3. pmset (сложно)

```bash
sudo pmset -a displaysleep 0
```

Минусы: требует sudo, нужно возвращать настройки

## Вывод

`caffeinate` - идеальное решение:

- ✅ Встроенная утилита (не нужно ничего устанавливать)
- ✅ Автоматически отключается
- ✅ Не требует sudo
- ✅ Работает только пока работает команда
- ✅ Не меняет системные настройки

## Ссылки

- Man page: `man caffeinate`
- Apple Docs: https://ss64.com/osx/caffeinate.html
